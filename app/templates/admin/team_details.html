<!-- app/templates/admin/team_details.html (VERSÃO FINAL E CORRIGIDA) -->
{% extends "base.html" %}

{% block styles %}
{{ super() }}
<style>
    .team-details-logo {
        max-width: 200px;
        max-height: 120px;
        object-fit: contain;
        margin-right: 15px;
    }
    .current-logo-container {
        display: flex;
        align-items: center;
        margin-top: 15px;
        margin-bottom: 15px;
        padding: 5px;
        border: 1px solid #ced4da;
        border-radius: 5px;
    }
    .current-logo-container img {
        max-width: 100px;
        max-height: 60px;
        object-fit: contain;
        margin-right: 10px;
        border: 1px solid #adb5bd;
        background-color: #fff;
        padding: 2px;
    }
    body[data-theme="dark"] .current-logo-container {
        background-color: transparent;
        border-color: #6c757d;
        color: #dee2e6;
    }
    body[data-theme="dark"] .current-logo-container img {
        background-color: #343a40;
        border-color: #adb5bd;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- CABEÇALHO DA PÁGINA -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <div class="d-flex align-items-center">
            <a href="{{ url_for('main.manage_groups') }}" class="btn btn-outline-secondary me-3" title="Voltar para a lista de equipes">
                <i class="fas fa-arrow-left"></i>
            </a>
            {% if grupo.logo_filename %}
                <img src="{{ url_for('main.serve_partner_logo', filename=grupo.logo_filename) }}" 
                     alt="Logo {{ grupo.nome }}" 
                     class="team-details-logo">
            {% endif %}
            <h2 class="mb-0">Gerenciar Equipe: <strong>{{ grupo.nome }}</strong></h2>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editTeamModal"><i class="fas fa-pencil-alt me-2"></i>Editar Equipe</button>
            <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteTeamModal"><i class="fas fa-trash-alt me-2"></i>Excluir Equipe</button>
        </div>
    </div>

    <!-- MÉTRICAS DA EQUIPE -->
    <div class="row mb-4">
        <div class="col-md-4 mb-3"><div class="card shadow-sm text-center h-100"><div class="card-body"><h6 class="card-subtitle mb-2 text-muted">Total de Membros</h6><p class="card-text display-4 fw-bold">{{ admins|length + consultores|length }}</p></div></div></div>
        <div class="col-md-4 mb-3"><div class="card shadow-sm text-center h-100"><div class="card-body"><h6 class="card-subtitle mb-2 text-muted">Consumo Mensal</h6><p class="card-text display-4 fw-bold">{{ monthly_consumption }} / <span class="text-muted fs-3">{{ grupo.monthly_pull_limit or '∞' }}</span></p></div></div></div>
        <div class="col-md-4 mb-3"><div class="card shadow-sm text-center h-100"><div class="card-body"><h6 class="card-subtitle mb-2 text-muted">Total de Logins</h6><p class="card-text display-4 fw-bold">{{ total_logins_group }}</p></div></div></div>
    </div>
    
    <!-- TABELA DE MEMBROS -->
    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Membros da Equipe</h5>
            <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addMemberModal"><i class="fas fa-user-plus me-2"></i>Adicionar Membro</button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead><tr><th>Nome</th><th>Email</th><th>Papel</th><th class="text-end">Ações</th></tr></thead>
                    <tbody>
                        {% for admin in admins %}
                        <tr>
                            <td>{{ admin.username }}</td><td>{{ admin.email }}</td><td><span class="badge bg-primary">Admin do Parceiro</span></td>
                            <td class="text-end">
                                {% if admin.role != 'super_admin' %}
                                <form class="d-inline" action="{{ url_for('main.remove_member_from_team', group_id=grupo.id, user_id=admin.id) }}" method="POST" onsubmit="return confirm('Tem certeza?');"><button type="submit" class="btn btn-sm btn-outline-warning">Remover</button></form>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        {% for consultor in consultores %}
                        <tr>
                            <td>{{ consultor.username }}</td><td>{{ consultor.email }}</td><td><span class="badge bg-secondary">Consultor</span></td>
                            <td class="text-end">
                                <form class="d-inline" action="{{ url_for('main.remove_member_from_team', group_id=grupo.id, user_id=consultor.id) }}" method="POST" onsubmit="return confirm('Tem certeza?');"><button type="submit" class="btn btn-sm btn-outline-warning">Remover</button></form>
                            </td>
                        </tr>
                        {% endfor %}
                        {% if not admins and not consultores %}
                        <tr><td colspan="4" class="text-center text-muted p-4">Nenhum membro nesta equipe ainda.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- MODAL PARA EDITAR A EQUIPE -->
<div class="modal fade" id="editTeamModal" tabindex="-1" aria-labelledby="editTeamModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="editTeamModalLabel">Editar Equipe: {{ grupo.nome }}</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
      <form action="{{ url_for('main.edit_group_name_color', group_id=grupo.id) }}" method="POST" enctype="multipart/form-data">
        <div class="modal-body">
            <div class="mb-3"><label for="name" class="form-label">Nome da Equipe</label><input type="text" name="name" class="form-control" value="{{ grupo.nome }}" required></div>
            <div class="mb-3"><label for="color" class="form-label">Cor do Grupo</label><input type="color" class="form-control form-control-color" name="color" value="{{ grupo.color }}" title="Escolha uma cor"></div>
            
            <!-- CORREÇÃO APLICADA AQUI -->
            <div class="mb-3">
                <label for="monthly_pull_limit" class="form-label">Limite Mensal de Puxada</label>
                <input type="number" name="monthly_pull_limit" id="monthly_pull_limit" class="form-control" value="{{ grupo.monthly_pull_limit or '' }}" placeholder="Deixe em branco para ilimitado">
            </div>

            <div class="mb-3">
                <label class="form-label">Logo da Equipe</label>
                {% if grupo.logo_filename %}
                    <div class="current-logo-container mb-2"><img src="{{ url_for('main.serve_partner_logo', filename=grupo.logo_filename) }}" alt="Logo Atual"><span>{{ grupo.logo_filename }}</span></div>
                    <div class="form-check mb-2"><input class="form-check-input" type="checkbox" id="remove_logo" name="remove_logo"><label class="form-check-label" for="remove_logo">Remover logo</label></div>
                {% endif %}
                <input class="form-control" type="file" name="logo_file" accept="image/png, image/jpeg, image/gif">
                <small class="form-text text-muted">Enviar novo arquivo substituirá o atual.</small>
            </div>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary">Salvar Alterações</button></div>
      </form>
    </div>
  </div>
</div>

<!-- MODAL PARA CONFIRMAR EXCLUSÃO -->
<div class="modal fade" id="deleteTeamModal" tabindex="-1" aria-labelledby="deleteTeamModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white"><h5 class="modal-title" id="deleteTeamModalLabel"><i class="fas fa-exclamation-triangle me-2"></i>Confirmar Exclusão</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir a equipe <strong>{{ grupo.nome }}</strong>?</p>
                <p class="text-danger">Esta ação não pode ser desfeita.</p>
                {% if grupo.users.count() > 0 %}<p class="text-warning fw-bold">Não é possível excluir, pois a equipe ainda contém {{ grupo.users.count() }} membro(s).</p>{% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                {% if grupo.users.count() == 0 %}
                <form action="{{ url_for('main.delete_group', group_id=grupo.id) }}" method="POST"><button type="submit" class="btn btn-danger">Sim, Excluir</button></form>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- MODAL PARA ADICIONAR MEMBRO -->
<div class="modal fade" id="addMemberModal" tabindex="-1" aria-labelledby="addMemberModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title" id="addMemberModalLabel">Adicionar Membro</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
        <form id="add-member-form" action="{{ url_for('main.add_member_to_team', group_id=grupo.id) }}" method="POST">
            <div class="modal-body">
                <p>Selecione o usuário para adicionar ou atualizar nesta equipe.</p>
                <div class="mb-3"><label for="user_id" class="form-label">Usuário</label><select name="user_id" class="form-select" required><option value="" disabled selected>-- Selecione --</option>{% for user in available_users %}<option value="{{ user.id }}">{{ user.username }} ({{ user.email }})</option>{% endfor %}</select></div>
                <div class="mb-3"><label for="role" class="form-label">Papel na Equipe</label><select name="role" id="member_role_select" class="form-select" required><option value="consultor">Consultor</option><option value="admin_parceiro">Admin do Parceiro</option></select></div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary">Adicionar / Atualizar</button></div>
        </form>
      </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    var addMemberModal = document.getElementById('addMemberModal');
    if (addMemberModal) {
        addMemberModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var role = button.getAttribute('data-member-role');
            var modalTitle = addMemberModal.querySelector('.modal-title');
            var roleSelect = addMemberModal.querySelector('#member_role_select');

            if (role === 'admin_parceiro') {
                modalTitle.textContent = 'Adicionar Supervisor à Equipe {{ grupo.nome }}';
            } else {
                modalTitle.textContent = 'Adicionar Agente à Equipe {{ grupo.nome }}';
            }
            if (role) {
                roleSelect.value = role;
            }
        });
    }
});
</script>
{% endblock %}